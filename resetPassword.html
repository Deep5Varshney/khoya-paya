<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/resetPassword.css">
    <title>Resest Password</title>
</head>
<body>
    <form id="resetPasswordForm">
        <div class = "container">
            <h1>Resest Password</h1>
            <h4>Make sure to set a Strong password this time!</h4>
            
            <label>New Password</label>
            <input type="password" id="password" class="password-change"/>

            <div class="details">
                <div class="password-details">
                    <div class="password-intro">
                        <i class="fa-solid fa-lightbulb bulb"></i> <h4>Tips for Creating a Strong Password:</h4>
                    </div>
                    <ul class="password-rules" >
                        <li>Ensure your password is <span>at least 8 characters long.</span></li>
                        <li>Include <span>at least one alphanumeric character</span>(letter or digit).</li>
                        <li>Incorporate <span>at least one numerical digit.</span></li>
                        <li>Avoid using <span>spaces</span>within the password.</li>
                        <li>Use a mix of <span>upper</span> and <span>lowercase letters.</span></li>
                    </ul>
                </div>
            </div>

            <label>Confirm Password</label>
            <input type="password" id = "confirmPassword"/>

            <div class ="last-info">
                <button type="submit">Save New Password</button><a href="./login.html" >Return to login</a>
            </div>
    
        </div>
    </form>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
         function validatePassword(password) {
            const minLength = 8;
            const hasAlphanumeric = /[a-zA-Z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpace = /\s/.test(password);

           // Check if the password meets all the criteria
            if (password.length >= minLength && hasAlphanumeric && hasNumber && !hasSpace) {
                return true; // Password is valid
            } else {
                return false; // Password does not meet the criteria
            }
        }

        if (sessionStorage.getItem("passwordChanged") === "true") {
        window.location.href = '/login.html';
        }
        document.getElementById('resetPasswordForm').addEventListener('submit',async function(e) {
            e.preventDefault();

            let password = document.getElementById('password').value;
            let confirmPassword = document.getElementById('confirmPassword').value;
            let token = new URLSearchParams(window.location.search).get('token'); // Get the token from the URL
            //console.log(token);

            if (password !== confirmPassword) {
                alert("Password and confirm password should match.");
                    return;
            }
            if (!validatePassword(password)) {
                alert("Password does not meet the required criteria.");
                return;
            }
            const domain = window.location.hostname;
            console.log(domain);


            try{
                let resp = await axios.post(`http://${domain}:3000/user/resetPassword`,{password, confirmPassword, token});
                console.log(resp);
                if(resp.data.message === "credentials updated successfully"){   
                    sessionStorage.setItem("passwordChanged", "true");
                     // Replace history state and redirect to main page
                     history.replaceState(null, null, '/login.html');
                    alert("Password updated successfully");
                } else {
                    alert(resp.data.message); // Show the alert with the message from the server
                }
            }
            catch(err){
                console.log(err);
            }
        })

        window.addEventListener('popstate', function (event) {
            if (sessionStorage.getItem("passwordChanged") === "true") {
                window.location.href = '/login.html';
            }
        });
    </script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $('.password-change').click(function(){
        $('.password-details').addClass('password-details-slider');
        $('.container').addClass('container-slider')
    })
</script>
</body>
</html>